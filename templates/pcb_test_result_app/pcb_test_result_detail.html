{% extends 'base.html' %}

{% block title %}Test Result Details - {{ test_result.pcb.serial_number }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Test Result Details</h2>
    <div>
        {% if perms.pcb_test_result_app.change_pcbtestresult %}
            <a href="{% url 'pcb_test_result_update' test_result.pk %}" class="btn btn-outline-secondary me-2">Edit</a>
        {% endif %}
        <a href="{% url 'pcb_test_result_list' %}" class="btn btn-outline-secondary">Back to List</a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">PCB Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Serial Number</th>
                        <td>{{ test_result.pcb.serial_number }}</td>
                    </tr>
                    <tr>
                        <th>Batch</th>
                        <td>{{ test_result.pcb.batch.name }}</td>
                    </tr>
                    <tr>
                        <th>PCB Type</th>
                        <td>{{ test_result.pcb.batch.pcb_type.name }}</td>
                    </tr>
                    <tr>
                        <th>Hardware Version</th>
                        <td>{{ test_result.pcb.effective_hardware_version }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Test Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Technician</th>
                        <td>{{ test_result.technician.username }}</td>
                    </tr>
                    <tr>
                        <th>Test Date</th>
                        <td>{{ test_result.test_date }}</td>
                    </tr>
                    <tr>
                        <th>Overall Result</th>
                        <td>
                            {% if test_result.result == 'PASSED' %}
                                <span class="badge bg-success">Passed</span>
                            {% elif test_result.result == 'FAILED' %}
                                <span class="badge bg-danger">Failed</span>
                            {% else %}
                                <span class="badge bg-warning">Incomplete</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Notes</th>
                        <td>{{ test_result.notes|default:"No notes" }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Step-by-step results in chronological order -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Test Steps in Order</h5>
    </div>
    <div class="card-body">
        {% for step in test_result.pcb.batch.test_config_type.steps.all %}
            <div class="mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header {% if step.step_type == 'VOLTAGE' %}bg-primary{% elif step.step_type == 'CURRENT' %}bg-info{% elif step.step_type == 'RESISTANCE' %}bg-warning text-dark{% elif step.step_type == 'FREQUENCY' %}bg-info{% elif step.step_type == 'QUESTION' %}bg-success{% elif step.step_type == 'INSTRUCTION' %}bg-secondary{% endif %} text-white">
                        <h6 class="mb-0 d-flex justify-content-between align-items-center">
                            <span>
                                <i class="{% if step.step_type == 'VOLTAGE' %}bi bi-bolt{% elif step.step_type == 'CURRENT' %}bi bi-lightning-charge{% elif step.step_type == 'RESISTANCE' %}bi bi-dash-circle{% elif step.step_type == 'FREQUENCY' %}bi bi-soundwave{% elif step.step_type == 'QUESTION' %}bi bi-question-circle{% elif step.step_type == 'INSTRUCTION' %}bi bi-info-circle{% endif %} me-2"></i>
                                Step {{ step.order }}: {{ step.get_step_type_display }}
                            </span>
                            {% if step.step_type == 'VOLTAGE' %}
                                {% for measurement in test_result.voltage_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'CURRENT' %}
                                {% for measurement in test_result.current_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'RESISTANCE' %}
                                {% for measurement in test_result.resistance_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'FREQUENCY' %}
                                {% for measurement in test_result.frequency_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'QUESTION' %}
                                {% for question in test_result.yes_no_questions.all %}
                                    {% if question.question_text == step.question_text and question.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif question.question_text == step.question_text and not question.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'INSTRUCTION' %}
                                {% for instruction in test_result.instructions.all %}
                                    {% if instruction.instruction_text == step.instruction_text and instruction.acknowledged %}
                                        <span class="badge bg-light text-success">DONE</span>
                                    {% elif instruction.instruction_text == step.instruction_text and not instruction.acknowledged %}
                                        <span class="badge bg-light text-warning">PENDING</span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="p-3">
                            {% if step.step_type == 'VOLTAGE' %}
                                {% for measurement in test_result.voltage_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"V" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"V" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'CURRENT' %}
                                {% for measurement in test_result.current_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"A" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"A" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'RESISTANCE' %}
                                {% for measurement in test_result.resistance_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"Ω" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"Ω" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'FREQUENCY' %}
                                {% for measurement in test_result.frequency_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"Hz" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"Hz" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'QUESTION' %}
                                {% for question in test_result.yes_no_questions.all %}
                                    {% if question.question_text == step.question_text %}
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">{{ question.question_text }}</h6>
                                                <p class="mb-0 text-muted">Required answer: {{ question.required_answer|yesno:"Yes,No" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ question.user_answer|yesno:"Yes,No" }}</h5>
                                                <span class="badge {% if question.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if question.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'INSTRUCTION' %}
                                {% for instruction in test_result.instructions.all %}
                                    {% if instruction.instruction_text == step.instruction_text %}
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">{{ instruction.instruction_text }}</h6>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge {% if instruction.acknowledged %}bg-success{% else %}bg-warning text-dark{% endif %} fs-6">
                                                    {% if instruction.acknowledged %}COMPLETED{% else %}PENDING{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- General Notes for the Test Result -->
{% if test_result.notes %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Test Result Notes</h5>
        </div>
        <div class="card-body">
            <p>{{ test_result.notes }}</p>
        </div>
    </div>
{% endif %}

{% endblock %}