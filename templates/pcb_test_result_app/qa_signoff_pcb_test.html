{% extends 'base.html' %}

{% block title %}QA Signoff - {{ pcb.serial_number }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>QA Signoff for {{ pcb.serial_number }}</h2>
    <div>
        <a href="{% url 'pcb_test_result_list' %}" class="btn btn-outline-secondary">Back to Search</a>
        <a href="{% url 'pcb_test_result_detail' test_result.pk %}" class="btn btn-outline-secondary">View Full Details</a>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">PCB Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Serial Number</th>
                        <td>{{ pcb.serial_number }}</td>
                    </tr>
                    <tr>
                        <th>Batch</th>
                        <td>{{ pcb.batch.name }}</td>
                    </tr>
                    <tr>
                        <th>PCB Type</th>
                        <td>{{ pcb.batch.pcb_type.name }}</td>
                    </tr>
                    <tr>
                        <th>Hardware Version</th>
                        <td>{{ pcb.effective_hardware_version }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Test Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Technician</th>
                        <td>{{ test_result.technician.username }}</td>
                    </tr>
                    <tr>
                        <th>Test Date</th>
                        <td>{{ test_result.test_date }}</td>
                    </tr>
                    <tr>
                        <th>Overall Result</th>
                        <td>
                            {% if test_result.result == 'PASSED' %}
                                <span class="badge bg-success">Passed</span>
                            {% elif test_result.result == 'FAILED' %}
                                <span class="badge bg-danger">Failed</span>
                            {% else %}
                                <span class="badge bg-warning">Incomplete</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Notes</th>
                        <td>{{ test_result.notes|default:"No notes" }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- QA Signoff Section -->
{% if existing_signoff %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">QA Signoff Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>QA Signoff Status:</strong> 
                        <span class="badge bg-success">Signed Off</span>
                    </p>
                    <p><strong>QA User:</strong> {{ existing_signoff.qa_user.username }}</p>
                    <p><strong>Signed Off At:</strong> {{ existing_signoff.signed_off_at|default:"N/A" }}</p>
                </div>
                <div class="col-md-6">
                    {% if existing_signoff.qa_notes %}
                        <p><strong>QA Notes:</strong></p>
                        <p>{{ existing_signoff.qa_notes }}</p>
                    {% else %}
                        <p><strong>QA Notes:</strong> No notes provided</p>
                    {% endif %}
                </div>
            </div>
            <div class="alert alert-info">
                This test result has already been signed off by a QA staff member.
            </div>
        </div>
    </div>
{% else %}
    <!-- Check if all tests passed before allowing signoff -->
    {% if all_tests_passed %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">QA Signoff</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="qa_notes" class="form-label fw-bold">QA Notes (optional)</label>
                        <textarea class="form-control" id="qa_notes" name="qa_notes" rows="4" 
                                  placeholder="Add any QA notes about this test result..."></textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'pcb_test_result_list' %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-success btn-lg px-4">Sign Off Test Result</button>
                    </div>
                </form>
            </div>
        </div>
    {% else %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">QA Signoff</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <h5 class="alert-heading">Cannot Sign Off!</h5>
                    <p>Not all tests have passed, so signoff is not allowed:</p>
                    <ul class="mb-0">
                        <li>Passing voltage measurements: {{ test_counts.voltage.passed }}/{{ test_counts.voltage.total }}</li>
                        <li>Passing current measurements: {{ test_counts.current.passed }}/{{ test_counts.current.total }}</li>
                        <li>Passing resistance measurements: {{ test_counts.resistance.passed }}/{{ test_counts.resistance.total }}</li>
                        <li>Passing frequency measurements: {{ test_counts.frequency.passed }}/{{ test_counts.frequency.total }}</li>
                        <li>Passing questions: {{ test_counts.questions.passed }}/{{ test_counts.questions.total }}</li>
                        <li>Completed instructions: {{ test_counts.instructions.passed }}/{{ test_counts.instructions.total }}</li>
                    </ul>
                    <p class="mb-0">All tests must pass before QA signoff can be performed.</p>
                </div>
            </div>
        </div>
    {% endif %}
{% endif %}

<!-- Step-by-step results in chronological order -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Test Steps in Order</h5>
    </div>
    <div class="card-body">
        {% for step in test_result.pcb.batch.test_config_type.steps.all %}
            <div class="mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header {% if step.step_type == 'VOLTAGE' %}bg-primary{% elif step.step_type == 'CURRENT' %}bg-info{% elif step.step_type == 'RESISTANCE' %}bg-warning text-dark{% elif step.step_type == 'FREQUENCY' %}bg-info{% elif step.step_type == 'QUESTION' %}bg-success{% elif step.step_type == 'INSTRUCTION' %}bg-secondary{% endif %} text-white">
                        <h6 class="mb-0 d-flex justify-content-between align-items-center">
                            <span>
                                <i class="{% if step.step_type == 'VOLTAGE' %}bi bi-bolt{% elif step.step_type == 'CURRENT' %}bi bi-lightning-charge{% elif step.step_type == 'RESISTANCE' %}bi bi-dash-circle{% elif step.step_type == 'FREQUENCY' %}bi bi-soundwave{% elif step.step_type == 'QUESTION' %}bi bi-question-circle{% elif step.step_type == 'INSTRUCTION' %}bi bi-info-circle{% endif %} me-2"></i>
                                Step {{ step.order }}: {{ step.get_step_type_display }}
                            </span>
                            {% if step.step_type == 'VOLTAGE' %}
                                {% for measurement in test_result.voltage_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'CURRENT' %}
                                {% for measurement in test_result.current_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'RESISTANCE' %}
                                {% for measurement in test_result.resistance_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'FREQUENCY' %}
                                {% for measurement in test_result.frequency_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name and measurement.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif measurement.parameter_name == step.parameter_name and not measurement.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'QUESTION' %}
                                {% for question in test_result.yes_no_questions.all %}
                                    {% if question.question_text == step.question_text and question.passed %}
                                        <span class="badge bg-light text-success">PASS</span>
                                    {% elif question.question_text == step.question_text and not question.passed %}
                                        <span class="badge bg-light text-danger">FAIL</span>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'INSTRUCTION' %}
                                {% for instruction in test_result.instructions.all %}
                                    {% if instruction.instruction_text == step.instruction_text and instruction.acknowledged %}
                                        <span class="badge bg-light text-success">DONE</span>
                                    {% elif instruction.instruction_text == step.instruction_text and not instruction.acknowledged %}
                                        <span class="badge bg-light text-warning">PENDING</span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="p-3">
                            {% if step.step_type == 'VOLTAGE' %}
                                {% for measurement in test_result.voltage_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"V" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"V" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'CURRENT' %}
                                {% for measurement in test_result.current_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"A" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"A" }}</p>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'RESISTANCE' %}
                                {% for measurement in test_result.resistance_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"Ω" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"Ω" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'FREQUENCY' %}
                                {% for measurement in test_result.frequency_measurements.all %}
                                    {% if measurement.parameter_name == step.parameter_name %}
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">{{ measurement.parameter_name }}</h6>
                                                <p class="mb-0 text-muted small">Required: {{ measurement.min_value }} - {{ measurement.max_value }} {{ measurement.unit|default:"Hz" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ measurement.measured_value|default:"N/A" }} {{ measurement.unit|default:"Hz" }}</h5>
                                                <span class="badge {% if measurement.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if measurement.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'QUESTION' %}
                                {% for question in test_result.yes_no_questions.all %}
                                    {% if question.question_text == step.question_text %}
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">{{ question.question_text }}</h6>
                                                <p class="mb-0 text-muted">Required answer: {{ question.required_answer|yesno:"Yes,No" }}</p>
                                            </div>
                                            <div class="text-end">
                                                <h5 class="mb-0">{{ question.user_answer|yesno:"Yes,No" }}</h5>
                                                <span class="badge {% if question.passed %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                    {% if question.passed %}PASS{% else %}FAIL{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif step.step_type == 'INSTRUCTION' %}
                                {% for instruction in test_result.instructions.all %}
                                    {% if instruction.instruction_text == step.instruction_text %}
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">{{ instruction.instruction_text }}</h6>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge {% if instruction.acknowledged %}bg-success{% else %}bg-warning text-dark{% endif %} fs-6">
                                                    {% if instruction.acknowledged %}COMPLETED{% else %}PENDING{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

{% endblock %}